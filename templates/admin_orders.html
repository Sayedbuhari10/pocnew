<!DOCTYPE html>
<html>
<head>
    <title>Admin Orders</title>

<style>
/* ================= BASE ================= */
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: #f1f5f9;
    color: #0f172a;
}

/* ================= HEADER ================= */
header {
    background: linear-gradient(135deg, #1e293b, #0f172a);
    color: white;
    padding: 18px 30px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}

header nav {
    margin-top: 8px;
}

header nav a {
    color: white;
    margin-right: 20px;
    font-weight: 600;
    text-decoration: none;
    opacity: 0.85;
}

header nav a:hover {
    opacity: 1;
}

/* ================= CONTAINER ================= */
.container {
    padding: 30px;
}

h2 {
    margin-top: 0;
    color: #1e293b;
}

/* ================= SECTION HEADERS ================= */
h3 {
    margin-top: 25px;
    padding: 10px 15px;
    background: #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 700;
    display: inline-block;
}

/* ================= ORDER CARD ================= */
.order-card {
    background: white;
    padding: 18px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    border-left: 5px solid #2563eb;
    transition: 0.25s ease;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.08);
}

/* Order title */
.order-card b {
    font-size: 1.05em;
    color: #1e40af;
}

/* ================= BUTTONS ================= */
button {
    margin-top: 8px;
    padding: 7px 14px;
    border: none;
    border-radius: 6px;
    background: #2563eb;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: 0.25s ease;
}

button:hover {
    opacity: 0.9;
}

/* Specific actions */
button.cancel {
    background: #dc2626;
}

button.deliver {
    background: #16a34a;
}

button.invoice {
    background: #0ea5e9;
}

/* ================= MODALS ================= */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
}

.modal-box {
    background: white;
    padding: 22px;
    width: 420px;
    border-radius: 14px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    animation: fadeUp 0.25s ease;
}

.modal-box h3 {
    margin-top: 0;
    text-align: center;
    color: #1e293b;
}

/* Modal content */
.modal-box ul {
    padding-left: 20px;
    margin: 15px 0;
}

.modal-box li {
    margin-bottom: 6px;
}

/* Date input */
input[type="date"] {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #cbd5f5;
    margin-bottom: 12px;
}

/* Modal buttons */
.modal-box button {
    width: 48%;
}

.modal-box button:last-child {
    background: #64748b;
}

/* ================= ANIMATION ================= */
@keyframes fadeUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ================= UTIL ================= */
.hidden {
    display: none;
}

/* ================= ORDER HEADER INLINE ================= */

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

/* Order number */
.order-title {
    font-size: 1.05em;
    font-weight: 700;
    color: #1e40af;
}

/* Status badge */
.order-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Status colors */
.status-PLACED {
    background: #fff7ed;
    color: #9a3412;
}

.status-ACCEPTED {
    background: #e0f2fe;
    color: #075985;
}

.status-DELIVERED {
    background: #dcfce7;
    color: #166534;
}

.status-COMPLETED {
    background: #ede9fe;
    color: #5b21b6;
}

/* ================= ORDER STATUS TABS ================= */

.order-status-bar {
    display: flex;
    gap: 40px;
    padding-bottom: 10px;
    margin-bottom: 25px;
    border-bottom: 1px solid #e5e7eb;
}

.status-tab {
    position: relative;
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    cursor: pointer;
    padding-bottom: 8px;
    opacity: 0.75;
    transition: 0.2s ease;
}

/* Active tab */
.status-tab.active {
    color: #1d4ed8;
    opacity: 1;
}

/* Blue underline */
.status-tab.active::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: -11px;
    width: 100%;
    height: 3px;
    background: #1d4ed8;
    border-radius: 2px;
}

/* Hover */
.status-tab:hover {
    opacity: 1;
}



</style>
</head>

<body>

<header>
    <strong>Admin Panel</strong>
    <nav>
        <a href="/admin">Home</a>
        <a href="/admin/products">Products</a>
        <a href="/admin/customers">Customers</a>
        <a href="/admin/orders">Orders</a>
    </nav>
</header>

<div class="container">
    <h2>Orders</h2>

<div class="order-status-bar">
    <span class="status-tab active" onclick="showOrders('placed')">PLACED</span>
    <span class="status-tab" onclick="showOrders('accepted')">ACCEPTED</span>
    <span class="status-tab" onclick="showOrders('delivered')">DELIVERED</span>
    <span class="status-tab" onclick="showOrders('completed')">COMPLETED</span>
</div>

<div id="placedOrders"></div>
<div id="acceptedOrders" class="hidden"></div>
<div id="deliveredOrders" class="hidden"></div>
<div id="completedOrders" class="hidden"></div>

<!-- DETAILS MODAL -->
<div id="orderDetailsModal" class="modal hidden">
    <div class="modal-box">
        <div id="orderDetailsContent"></div>
        <button id="acceptOrderBtn" onclick="openAcceptModal()" class="hidden">Accept Order</button>
        <button onclick="closeOrderDetails()">Close</button>
    </div>
</div>

<!-- ACCEPT / EDIT MODAL -->
<div id="acceptOrderModal" class="modal hidden">
    <div class="modal-box">
        <input type="date" id="deliveryDate">
        <br>
        <button onclick="saveOrder()">Save</button>
        <button onclick="closeAcceptModal()">Close</button>
    </div>
</div>

<script>
let currentOrderId = null;
let isEditMode = false;

/* ---------------- PLACED ORDERS ---------------- */
function loadPlacedOrders() {
    fetch("/admin/api/orders/placed")
        .then(r => r.json())
        .then(data => {
            placedOrders.innerHTML = "";
            data.forEach(o => {
                placedOrders.innerHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-title">
                                Order ${o.order_no} – ${o.customer_name}
                            </div>
                            <span class="order-status status-${o.status}">
                                ${o.status}
                            </span>
                            </div> 

                        <button onclick="viewPlacedDetails('${o.id}')">View</button>
                        <button onclick="cancelOrder('${o.id}')">Cancel</button>
                    </div>`;
            });
        });
}

function viewPlacedDetails(id) {
    currentOrderId = id;
    fetch(`/admin/api/order/details/${id}`)
        .then(r => r.json())
        .then(o => {
            let html = `<h3>Order ${o.order_no}</h3><ul>`;
            o.items.forEach(i => html += `<li>${i.name} × ${i.quantity}</li>`);
            html += "</ul>";
            orderDetailsContent.innerHTML = html;
            acceptOrderBtn.classList.remove("hidden");
            orderDetailsModal.classList.remove("hidden");
        });
}

function cancelOrder(id) {
    fetch(`/admin/api/order/cancel/${id}`, { method: "POST" })
        .then(loadPlacedOrders);
}

/* ---------------- ACCEPT / EDIT ---------------- */
function openAcceptModal() {
    isEditMode = false;
    const d = new Date();
    d.setDate(d.getDate() + 3);
    deliveryDate.value = d.toISOString().split("T")[0];
    acceptOrderModal.classList.remove("hidden");
}

function saveOrder() {
    const url = isEditMode
        ? `/admin/api/order/edit-delivery/${currentOrderId}`
        : `/admin/api/order/accept/${currentOrderId}`;

    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            arrival_date: deliveryDate.value   // ✅ FIX
        })
    }).then(() => {
        closeAcceptModal();
        closeOrderDetails();
        showOrders("accepted");
    });
}

/* ---------------- ACCEPTED ---------------- */
function loadAcceptedOrders() {
    fetch("/admin/api/orders/accepted")
        .then(r => r.json())
        .then(data => {
            acceptedOrders.innerHTML = "";
            data.forEach(o => {
                acceptedOrders.innerHTML += `
                    <div class="order-card">
                        <b>Order ${o.order_no}</b> – ${o.customer_name}<br>
                        Delivery: ${o.arrival_date}<br>
                        <button onclick="editDelivery('${o.id}', '${o.arrival_date}')">Edit</button>
                        <button onclick="deliverOrder('${o.id}')">Deliver</button>
                    </div>`;
            });
        });
}
function editDelivery(id, date) {
    isEditMode = true;
    currentOrderId = id;
    deliveryDate.value = date;
    acceptOrderModal.classList.remove("hidden");
}

function deliverOrder(id) {
    fetch(`/admin/api/order/deliver/${id}`, { method: "POST" })
        .then(() => {
            showOrders("delivered");


        });
}

/* ---------------- DELIVERED ---------------- */

function loadDeliveredOrders() {
    fetch("/admin/api/orders/delivered")
        .then(r => r.json())
        .then(data => {
            deliveredOrders.innerHTML = "";
            data.forEach(o => {
                deliveredOrders.innerHTML += `
                    <div class="order-card">
                        <b>Order ${o.order_no}</b> – ${o.customer_name}<br>
                        <button onclick="viewDeliveredDetails('${o.id}')">View</button>
                        ${
                            o.invoice_sent
                            ? `<button onclick="viewInvoice('${o.id}')">Invoice</button>`
                            : `<button onclick="sendInvoice('${o.id}')">Send Invoice</button>`
                        }
                    </div>`;
            });
        });
}
function viewDeliveredDetails(id) {
    fetch(`/admin/api/order/details/${id}`)
        .then(r => r.json())
        .then(o => {
            let html = `<h3>Order ${o.order_no}</h3><ul>`;
            o.items.forEach(i => html += `<li>${i.name} × ${i.quantity}</li>`);
            html += "</ul>";
            orderDetailsContent.innerHTML = html;
            acceptOrderBtn.classList.add("hidden");
            orderDetailsModal.classList.remove("hidden");
        });
}

function loadCompletedOrders() {
    fetch("/admin/api/orders/completed")
        .then(r => r.json())
        .then(data => {
            completedOrders.innerHTML = "";
            data.forEach(o => {
                completedOrders.innerHTML += `
                    <div class="order-card">
                        <b>Order ${o.order_no}</b> – ${o.customer_name}
                    </div>`;
            });
        });
}


/* ---------------- INVOICE ---------------- */
function sendInvoice(id) {
    fetch(`/admin/api/invoice/send/${id}`, { method: "POST" })
        .then(() => {
            alert("Invoice sent");
            showOrders("delivered");

        });
}

function viewInvoice(id) {
    fetch(`/admin/api/invoice/by-order/${id}`)
        .then(r => r.json())
        .then(inv => {
            let html = `<h3>Invoice</h3><ul>`;
            inv.items.forEach(i => html += `<li>${i.name} × ${i.quantity} — ₹${i.amount}</li>`);
            html += `</ul><b>Total: ₹${inv.total}</b>`;
            orderDetailsContent.innerHTML = html;
            acceptOrderBtn.classList.add("hidden");
            orderDetailsModal.classList.remove("hidden");
        });
}

/* ---------------- CLOSE MODALS ---------------- */
function closeOrderDetails() {
    orderDetailsModal.classList.add("hidden");
}
function closeAcceptModal() {
    acceptOrderModal.classList.add("hidden");
}

/* INIT */
function showOrders(type) {

    // reset tabs
    document.querySelectorAll(".status-tab")
        .forEach(tab => tab.classList.remove("active"));

    // hide all sections
    ["placed","accepted","delivered","completed"].forEach(t => {
        document.getElementById(t + "Orders").classList.add("hidden");
    });

    // activate selected tab
    document.querySelector(`.status-tab[onclick*="${type}"]`)
        .classList.add("active");

    // show selected section
    document.getElementById(type + "Orders")
        .classList.remove("hidden");

    // load data
    if (type === "placed") loadPlacedOrders();
    if (type === "accepted") loadAcceptedOrders();
    if (type === "delivered") loadDeliveredOrders();
    if (type === "completed") loadCompletedOrders();
}
showOrders("placed");

</script>

</body>
</html>