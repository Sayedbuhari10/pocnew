<!DOCTYPE html>
<html>
<head>
    <title>Admin Orders</title>

    <style>
    /* ================= BASE ================= */
    body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #0a49b9, #0b57cc, #0d63e0);
    }

    /* Utility */
    .hidden {
        display: none;
    }

    /* ================= HEADER ================= */
    header {
        background: white;
        padding: 18px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    header nav a {
        margin-right: 20px;
        font-weight: 600;
        text-decoration: none;
        color: #334155;
    }

    header nav a.active {
        color: #2563eb;
    }

    /* ================= CONTAINER ================= */
    .container {
        background: rgba(255,255,255,0.95);
        margin: 40px;
        padding: 32px;
        border-radius: 18px;
        box-shadow: 0 40px 100px rgba(0,0,0,0.25);
        animation: fadeUp 0.4s ease;
    }

    h2 {
        margin-bottom: 22px;
        color: #0f172a;
    }

    /* ================= FILTER BAR ================= */
    .order-filters {
        display: flex;
        gap: 14px;
        margin-bottom: 24px;
    }

    .order-filters button {
        padding: 8px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        background: #e5e7eb;
        color: #334155;
        transition: 0.2s ease;
    }

    .order-filters button.active {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
    }

    /* ================= ORDER CARD ================= */
    .order-card {
        background: white;
        padding: 22px;
        border-radius: 16px;
        margin-bottom: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        transition: 0.25s ease;
    }

    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 45px rgba(0,0,0,0.15);
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
        gap: 10px;
        flex-wrap: wrap;
    }

    .order-title {
        font-size: 16px;
        font-weight: 700;
        color: #1e293b;
    }

    .order-no {
        font-size: 18px;
        font-weight: 700;
        color: #1e40af;
    }

    .order-date {
        font-size: 13px;
        color: #64748b;
    }

    /* status badge */
    .order-status {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        white-space: nowrap;
    }

    .status-PLACED {
        background: #fef3c7;
        color: #92400e;
    }

    .status-ACCEPTED {
        background: #e0f2fe;
        color: #075985;
    }

    .status-DELIVERED {
        background: #dcfce7;
        color: #166534;
    }

    .status-COMPLETED {
        background: #ede9fe;
        color: #5b21b6;
    }

    /* footer */
    .order-footer {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* buttons */
    .order-footer button,
    .order-footer a,
    .order-card button {
        padding: 8px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        color: #5b21b6 ;
        font-size: 13px;
    }

    .delete-btn {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    .edit-btn {
        background: linear-gradient(135deg, #64748b, #475569);
    }

    .invoice-btn {
        background: linear-gradient(135deg, #0ea5e9, #0284c7);
    }

    .primary-btn {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }

    /* ================= EMPTY STATE ================= */
    .no-orders {
        padding: 60px;
        text-align: center;
        color: #64748b;
        font-weight: 600;
    }

    /* ================= MODALS ================= */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(2,6,23,0.65);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal.hidden {
        display: none;
    }

    .modal-box {
        background: linear-gradient(180deg, #ffffff, #f8fafc);
        padding: 32px;
        width: 420px;
        max-width: 90vw;
        border-radius: 18px;
        animation: scaleIn 0.25s ease;
    }

    .modal-box h3 {
        margin-top: 0;
        margin-bottom: 12px;
        color: #0f172a;
    }

    .modal-box input[type="date"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        font-family: inherit;
    }

    /* ================= ANIMATIONS ================= */
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
    }
    </style>
</head>

<body>

<header>
    <strong>Admin Panel</strong>
    <nav>
        <a href="/admin">Home</a>
        <a href="/admin/products">Products</a>
        <a href="/admin/customers">Customers</a>
        <a href="/admin/orders" class="active">Orders</a>
    </nav>
</header>

<div class="container">
    <h2>Orders</h2>

    <!-- FILTER BAR -->
    <div class="order-filters">
        <button class="status-tab active" onclick="showOrders('placed')">Placed</button>
        <button class="status-tab" onclick="showOrders('accepted')">Accepted</button>
        <button class="status-tab" onclick="showOrders('delivered')">Delivered</button>
        <button class="status-tab" onclick="showOrders('completed')">Completed</button>
    </div>

    <!-- ORDER SECTIONS (REQUIRED BY JS) -->
    <div id="placedOrders"></div>
    <div id="acceptedOrders" class="hidden"></div>
    <div id="deliveredOrders" class="hidden"></div>
    <div id="completedOrders" class="hidden"></div>
</div>

<!-- ORDER DETAILS MODAL -->
<div id="orderDetailsModal" class="modal hidden">
  <div class="modal-box">
    <div id="orderDetailsContent"></div>
    <div style="margin-top:15px; text-align:right; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
        <button id="acceptOrderBtn"
                onclick="openAcceptModal()"
                class="edit-btn">
            Accept
        </button>
        <button onclick="closeOrderDetails()" class="delete-btn">
            Close
        </button>
    </div>
  </div>
</div>

<!-- ACCEPT / EDIT DELIVERY MODAL -->
<div id="acceptOrderModal" class="modal hidden">
  <div class="modal-box">
    <h3>Set Delivery Date</h3>
    <input type="date" id="deliveryDate">
    <div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button onclick="saveOrder()" class="edit-btn">Save</button>
        <button onclick="closeAcceptModal()" class="delete-btn">Cancel</button>
    </div>
  </div>
</div>

<!-- Your external JS, if any -->
<script src="/static/js/admin_orders.js"></script>

<script>
/* ================= DOM ELEMENTS ================= */
const placedOrders = document.getElementById("placedOrders");
const acceptedOrders = document.getElementById("acceptedOrders");
const deliveredOrders = document.getElementById("deliveredOrders");
const completedOrders = document.getElementById("completedOrders");

const orderDetailsModal = document.getElementById("orderDetailsModal");
const orderDetailsContent = document.getElementById("orderDetailsContent");
const acceptOrderModal = document.getElementById("acceptOrderModal");
const deliveryDate = document.getElementById("deliveryDate");
const acceptOrderBtn = document.getElementById("acceptOrderBtn");

/* ================= STATE ================= */
let currentOrderId = null;
let isEditMode = false;

/* ---------------- PLACED ORDERS ---------------- */
function loadPlacedOrders() {
    fetch("/admin/api/orders/placed")
        .then(r => r.json())
        .then(data => {
            placedOrders.innerHTML = "";
            if (!data.length) {
                placedOrders.innerHTML = '<div class="no-orders">No placed orders.</div>';
                return;
            }
            data.forEach(o => {
                placedOrders.innerHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-title">
                                Order ${o.order_no} â€“ ${o.customer_name}
                            </div>
                            <span class="order-status status-${o.status}">
                                ${o.status}
                            </span>
                        </div>
                        <div class="order-footer">
                            <button class="edit-btn" onclick="viewPlacedDetails('${o.id}')">View</button>
                            <button class="delete-btn" onclick="cancelOrder('${o.id}')">Cancel</button>
                        </div>
                    </div>`;
            });
        })
        .catch(err => {
            console.error(err);
            placedOrders.innerHTML = '<div class="no-orders">Failed to load placed orders.</div>';
        });
}

function viewPlacedDetails(id) {
    currentOrderId = id;
    fetch(`/admin/api/order/details/${id}`)
        .then(r => r.json())
        .then(o => {
            let html = `<h3>Order ${o.order_no}</h3>`;
            html += `<p>${o.customer_name}</p>`;
            html += `<ul>`;
            o.items.forEach(i => html += `<li>${i.name} Ã— ${i.quantity}</li>`);
            html += `</ul>`;
            orderDetailsContent.innerHTML = html;
            acceptOrderBtn.classList.remove("hidden");
            orderDetailsModal.classList.remove("hidden");
        });
}

function cancelOrder(id) {
    if (!confirm("Cancel this order?")) return;
    fetch(`/admin/api/order/cancel/${id}`, { method: "POST" })
        .then(loadPlacedOrders);
}

/* ---------------- ACCEPT / EDIT ---------------- */
function openAcceptModal() {
    isEditMode = false;
    const d = new Date();
    d.setDate(d.getDate() + 3);
    deliveryDate.value = d.toISOString().split("T")[0];
    acceptOrderModal.classList.remove("hidden");
}

function saveOrder() {
    if (!currentOrderId) return;

    const url = isEditMode
        ? `/admin/api/order/edit-delivery/${currentOrderId}`
        : `/admin/api/order/accept/${currentOrderId}`;

    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            arrival_date: deliveryDate.value
        })
    }).then(() => {
        closeAcceptModal();
        closeOrderDetails();
        showOrders("accepted");
    });
}

/* ---------------- ACCEPTED ---------------- */
function loadAcceptedOrders() {
    fetch("/admin/api/orders/accepted")
        .then(r => r.json())
        .then(data => {
            acceptedOrders.innerHTML = "";
            if (!data.length) {
                acceptedOrders.innerHTML = '<div class="no-orders">No accepted orders.</div>';
                return;
            }
            data.forEach(o => {
                acceptedOrders.innerHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-title">
                                Order ${o.order_no} â€“ ${o.customer_name}
                            </div>
                            <span class="order-status status-${o.status}">
                                ${o.status}
                            </span>
                        </div>
                        <div class="order-date">Delivery: ${o.arrival_date}</div>
                        <div class="order-footer">
                            <button class="edit-btn" onclick="editDelivery('${o.id}', '${o.arrival_date}')">Edit delivery</button>
                            <button class="primary-btn" onclick="deliverOrder('${o.id}')">Mark delivered</button>
                        </div>
                    </div>`;
            });
        })
        .catch(err => {
            console.error(err);
            acceptedOrders.innerHTML = '<div class="no-orders">Failed to load accepted orders.</div>';
        });
}

function editDelivery(id, date) {
    isEditMode = true;
    currentOrderId = id;
    deliveryDate.value = date;
    acceptOrderModal.classList.remove("hidden");
}

function deliverOrder(id) {
    fetch(`/admin/api/order/deliver/${id}`, { method: "POST" })
        .then(() => {
            showOrders("delivered");
        });
}

/* ---------------- DELIVERED ---------------- */
function loadDeliveredOrders() {
    fetch("/admin/api/orders/delivered")
        .then(r => r.json())
        .then(data => {
            deliveredOrders.innerHTML = "";
            if (!data.length) {
                deliveredOrders.innerHTML = '<div class="no-orders">No delivered orders.</div>';
                return;
            }
            data.forEach(o => {
                deliveredOrders.innerHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-title">
                                Order ${o.order_no} â€“ ${o.customer_name}
                            </div>
                            <span class="order-status status-${o.status}">
                                ${o.status}
                            </span>
                        </div>
                        <div class="order-footer">
                            <button class="edit-btn" onclick="viewDeliveredDetails('${o.id}')">View</button>
                            ${
                                o.invoice_sent
                                ? `<button class="invoice-btn" onclick="viewInvoice('${o.id}')">Invoice</button>`
                                : `<button class="primary-btn" onclick="sendInvoice('${o.id}')">Send Invoice</button>`
                            }
                        </div>
                    </div>`;
            });
        })
        .catch(err => {
            console.error(err);
            deliveredOrders.innerHTML = '<div class="no-orders">Failed to load delivered orders.</div>';
        });
}

function viewDeliveredDetails(id) {
    fetch(`/admin/api/order/details/${id}`)
        .then(r => r.json())
        .then(o => {
            let html = `<h3>Order ${o.order_no}</h3>`;
            html += `<p>${o.customer_name}</p>`;
            html += `<ul>`;
            o.items.forEach(i => html += `<li>${i.name} Ã— ${i.quantity}</li>`);
            html += `</ul>`;
            orderDetailsContent.innerHTML = html;
            acceptOrderBtn.classList.add("hidden");
            orderDetailsModal.classList.remove("hidden");
        });
}

/* ---------------- COMPLETED ---------------- */
function viewCompletedOrderDetails(orderId) {
    fetch(`/admin/api/order/${orderId}`)
        .then(r => r.json())
        .then(o => {
            let html = `
                <h3>Order Details</h3>

                <p><b>Order ID:</b> ${orderId}</p>
                <p><b>Order No:</b> ${o.order_no}</p>
                <p><b>Customer:</b> ${o.customer_name}</p>

                <h4>Items</h4>
                <ul>
            `;

            o.items.forEach(i => {
                html += `<li>${i.name} Ã— ${i.quantity}</li>`;
            });

            html += `
                </ul>

                <p><b>Created:</b> ${new Date(o.created_at).toLocaleString()}</p>
                <p><b>Accepted:</b> ${o.accepted_at ? new Date(o.accepted_at).toLocaleString() : "-"}</p>
                <p><b>Delivered:</b> ${o.delivered_at ? new Date(o.delivered_at).toLocaleString() : "-"}</p>
                <p><b>Arrival Date:</b> ${o.arrival_date || "-"}</p>
                <p><b>Invoice Sent:</b> ${o.invoice_sent ? "Yes" : "No"}</p>
            `;

            document.getElementById("orderDetailsContent").innerHTML = html;
            document.getElementById("orderDetailsModal")
                .classList.remove("hidden");
        });
}
function loadCompletedOrders() {
    fetch("/admin/api/orders/completed")
        .then(r => r.json())
        .then(data => {
            completedOrders.innerHTML = "";

            // ðŸ”´ FORCE VISIBILITY (THIS IS THE FIX)
            completedOrders.classList.remove("hidden");

            if (!data.length) {
                completedOrders.innerHTML =
                    '<div class="no-orders">No completed orders.</div>';
                return;
            }

            data.forEach(o => {
                completedOrders.innerHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-title">
                                Order ${o.order_no} â€“ ${o.customer_name}
                            </div>
                            <span class="order-status status-COMPLETED">
                                COMPLETED
                            </span>
                        </div>

                        <div class="order-footer">
                            <button onclick="viewCompletedOrderDetails('${o.id}')">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
            });
        })
        .catch(err => {
            console.error("Completed orders error:", err);
            completedOrders.innerHTML =
                '<div class="no-orders">Failed to load completed orders.</div>';
        });
}



/* ---------------- INVOICE ---------------- */
function sendInvoice(id) {
    fetch(`/admin/api/invoice/send/${id}`, { method: "POST" })
        .then(() => {
            alert("Invoice sent");
            showOrders("delivered");
        });
}

function viewInvoice(id) {
    fetch(`/admin/api/invoice/by-order/${id}`)
        .then(r => r.json())
        .then(inv => {
            let html = `<h3>Invoice</h3><ul>`;
            inv.items.forEach(i => html += `<li>${i.name} Ã— ${i.quantity} â€” â‚¹${i.amount}</li>`);
            html += `</ul><b>Total: â‚¹${inv.total}</b>`;
            orderDetailsContent.innerHTML = html;
            acceptOrderBtn.classList.add("hidden");
            orderDetailsModal.classList.remove("hidden");
        });
}

/* ---------------- CLOSE MODALS ---------------- */
function closeOrderDetails() {
    orderDetailsModal.classList.add("hidden");
}
function closeAcceptModal() {
    acceptOrderModal.classList.add("hidden");
}

/* INIT */
function showOrders(type) {
    // reset tabs
    document.querySelectorAll(".status-tab")
        .forEach(tab => tab.classList.remove("active"));

    // hide all sections
    ["placed","accepted","delivered","completed"].forEach(t => {
        const el = document.getElementById(t + "Orders");
        if (el) el.classList.add("hidden");
    });

    // activate selected tab
    const activeTab = document.querySelector(`.status-tab[onclick*="${type}"]`);
    if (activeTab) activeTab.classList.add("active");

    // show selected section
    const section = document.getElementById(type + "Orders");
    if (section) section.classList.remove("hidden");

    // load data
    if (type === "placed") loadPlacedOrders();
    if (type === "accepted") loadAcceptedOrders();
    if (type === "delivered") loadDeliveredOrders();
    if (type === "completed") loadCompletedOrders();
}

// first load
showOrders("placed");
</script>

</body>
</html>

