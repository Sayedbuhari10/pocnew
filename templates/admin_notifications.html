<!DOCTYPE html>
<html>
<head>
    <title>Admin Notifications</title>

    <style>
    /* ================= BASE ================= */
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
        background: linear-gradient(135deg, #0a49b9, #0b57cc, #0d63e0);
        color: #0f172a;
    }

    .hidden {
        display: none;
    }

    /* ================= HEADER (same as orders) ================= */
    header {
        background: white;
        padding: 18px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    header nav a {
        margin-right: 20px;
        font-weight: 600;
        text-decoration: none;
        color: #334155;
    }

    header nav a.active {
        color: #2563eb;
    }

    /* ================= CONTAINER (same style) ================= */
    .container {
        background: rgba(255,255,255,0.95);
        margin: 40px;
        padding: 32px;
        border-radius: 18px;
        box-shadow: 0 40px 100px rgba(0,0,0,0.25);
        animation: fadeUp 0.4s ease;
    }

    h2 {
        margin-top: 0;
        margin-bottom: 22px;
        color: #1e293b;
    }

    /* ================= NOTIFICATION CARD (aligned with order cards) ================= */
    .notification-card {
        background: white;
        padding: 18px 20px;
        border-radius: 16px;
        margin-bottom: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border-left: 5px solid #2563eb;
        transition: 0.25s ease;
    }

    .notification-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 45px rgba(0,0,0,0.15);
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 6px;
    }

    .notification-title {
        font-weight: 700;
        color: #1e293b;
    }

    .notification-card b {
        color: #1e40af;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        background: #e5e7eb;
        color: #334155;
        white-space: nowrap;
    }

    .badge-PLACED {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-DELIVERED {
        background: #dcfce7;
        color: #166534;
    }

    .notification-meta {
        font-size: 13px;
        color: #64748b;
    }

    .actions {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
    }

    /* ================= BUTTONS (reused from orders) ================= */
    button {
        padding: 8px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        background: #2563eb;
        color: white;
        font-size: 13px;
    }

    button.close-btn {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }
    button.close-but {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    button.invoice-btn {
        background: linear-gradient(135deg, #0ea5e9, #0284c7);
    }

    button.secondary-btn {
        background: linear-gradient(135deg, #5ea357, #04bb10c8);
    }

    .empty {
        padding: 40px;
        text-align: center;
        color: #64748b;
        font-weight: 600;
    }

    /* ================= MODALS (aligned with orders) ================= */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(2,6,23,0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 900;
    }

    .modal.hidden {
        display: none;
    }

    .modal-box {
        background: linear-gradient(180deg, #ffffff, #f8fafc);
        padding: 24px 26px;
        width: 420px;
        max-width: 90vw;
        border-radius: 18px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        animation: scaleIn 0.25s ease;
    }

    .modal-box h3 {
        margin-top: 0;
        margin-bottom: 14px;
        text-align: left;
        color: #1e293b;
    }

    .modal-box input[type="date"] {
        width: 100%;
        padding: 8px 10px;
        margin: 10px 0 18px;
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        font-family: inherit;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    /* stacking: arrival modal above details */
    #orderDetailsModal {
        z-index: 900;
    }
    #acceptModal {
        z-index: 1000;
    }

    /* ================= ANIMATIONS ================= */
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.95); }
        to   { opacity: 1; transform: scale(1); }
    }

     button.close-but {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }
    </style>
</head>

<body>

<header>
    <strong>Admin Panel</strong>
    <nav>
        <a href="/admin">Home</a>
        <a href="/admin/products">Products</a>
        <a href="/admin/customers">Customers</a>
        <a href="/admin/orders">Orders</a>
        <a href="/admin/notification" class="active">Notifications</a>
    </nav>
</header>

<div class="container">
    <h2>Notifications</h2>
    <div id="notificationList"></div>
</div>

<!-- ARRIVAL DATE MODAL -->
<div id="acceptModal" class="modal hidden">
    <div class="modal-box">
        <h3>Set Arrival Date</h3>
        <input type="date" id="arrivalDate">
        <div class="modal-actions">
            <button class="secondary-btn" onclick="saveArrivalDate()">Save</button>
            <button class="close-btn" onclick="closeAcceptModal()">Cancel</button>
        </div>
    </div>
</div>
<!-- COMPLETED ORDER DETAILS MODAL -->
<div id="completedDetailsModal" class="modal hidden">
  <div class="modal-box">
    <div id="completedDetailsContent"></div>

    <button class="close-but" onclick="closeCompletedDetails()">
        Close
    </button>
  </div>
</div>


<!-- ORDER DETAILS MODAL -->
<div id="orderDetailsModal" class="modal hidden">
  <div class="modal-box">
    <div id="orderDetailsContent"></div>

    <div class="modal-actions" style="margin-top:16px;">
        <button id="saveBtn" class="secondary-btn" onclick="openSaveDateModal()">
            Set arrival date
        </button>

        <button id="confirmAcceptBtn"
                class="hidden secondary-btn"
                onclick="confirmAcceptOrder()">
            Confirm accept
        </button>

        <button class="close-btn" onclick="closeOrderDetails()">Close</button>
    </div>
  </div>
</div>

<script>
let currentOrderId = null;
let currentNotificationId = null;
let savedArrivalDate = null;
let completedNotificationId = null;
function closeCompletedDetails() {
    document.getElementById("completedDetailsModal")
        .classList.add("hidden");

    // DELETE notification AFTER viewing
    fetch(`/admin/notification/delete/${completedNotificationId}`, {
        method: "POST"
    }).then(() => {
        completedNotificationId = null;
        loadNotifications();
    });
}


/* VIEW COMPLETED ORDER DETAILS */
function viewCompletedDetails(orderId, notificationId) {
    completedNotificationId = notificationId;

    fetch(`/admin/api/order/details/${orderId}`)
        .then(r => r.json())
        .then(o => {
            let html = `
                <h3>Order ${o.order_no}</h3>
                <ul>
            `;

            o.items.forEach(i => {
                html += `<li>${i.name} × ${i.quantity}</li>`;
            });

            html += `
                </ul>
                <p><b>Ordered On:</b>
                    ${new Date(o.created_at).toLocaleString()}
                </p>
            `;

            document.getElementById("completedDetailsContent")
                .innerHTML = html;

            document.getElementById("completedDetailsModal")
                .classList.remove("hidden");
        });
}

/* LOAD NOTIFICATIONS */
function loadNotifications() {
    fetch("/admin/api/notifications")
        .then(res => res.json())
        .then(data => {
            const div = document.getElementById("notificationList");
            div.innerHTML = "";

            if (!data.length) {
                div.innerHTML = `<div class="empty">No notifications</div>`;
                return;
            }

            data.forEach(n => {
                let actions = "";

                if (n.state === "PLACED") {
                    actions = `
                        <button class="secondary-btn" onclick="viewOrderFromNotification(
                            '${n.order_id}',
                            '${n.notification_id}'
                        )">
                            Accept
                        </button>
                        <button class="close-btn" onclick="closeNotification('${n.notification_id}')">
                            Close
                        </button>
                    `;
                }

                if (n.state === "DELIVERED") {
                    actions = `
                        <button class="invoice-btn" onclick="sendInvoice('${n.order_id}', '${n.notification_id}')">
                            Send Invoice
                        </button>
                        <button class="close-btn" onclick="closeNotification('${n.notification_id}')">
                            Close
                        </button>
                    `;
                }
                if (n.state === "COMPLETED") {
    actions = `
        <button onclick="viewCompletedDetails(
            '${n.order_id}',
            '${n.notification_id}'
        )">
            View Details
        </button>
        <button class="close-btn"
                onclick="closeNotification('${n.notification_id}')">
            Close
        </button>
    `;
}


                div.innerHTML += `
                    <div class="notification-card">
                        <div class="notification-header">
                            <div class="notification-title">
                                <b>Order ${n.order_no}</b> – ${n.customer_name}
                            </div>
                            <span class="badge badge-${n.state}">${n.state}</span>
                        </div>
                        <div class="actions">${actions}</div>
                    </div>
                `;
            });
        });
}

/* STEP 1: VIEW ORDER DETAILS */
function viewOrderFromNotification(orderId, notificationId,) {
    currentOrderId = orderId;
    currentNotificationId = notificationId;
    savedArrivalDate = null;
    

    fetch(`/admin/api/order/details/${orderId}`)
        .then(r => r.json())
        .then(o => {
            let html = `<h3>Order ${o.order_no}</h3><ul>`;
            o.items.forEach(i => {
                html += `<li>${i.name} × ${i.quantity}</li>`;
            });
            html += `</ul>`;
            

            document.getElementById("orderDetailsContent").innerHTML = html;

            document.getElementById("confirmAcceptBtn")
                .classList.add("hidden");

            document.getElementById("orderDetailsModal")
                .classList.remove("hidden");
        });
}

/* ARRIVAL DATE FLOW */
function openSaveDateModal() {
    const d = new Date();
    d.setDate(d.getDate() + 3);
    document.getElementById("arrivalDate").value = d.toISOString().split("T")[0];

    document.getElementById("orderDetailsModal")
        .classList.add("hidden");
    document.getElementById("acceptModal")
        .classList.remove("hidden");
}

function saveArrivalDate() {
    savedArrivalDate = document.getElementById("arrivalDate").value;

    document.getElementById("acceptModal")
        .classList.add("hidden");

    document.getElementById("confirmAcceptBtn")
        .classList.remove("hidden");

    document.getElementById("orderDetailsModal")
        .classList.remove("hidden");
}

/* FINAL ACCEPT USING savedArrivalDate */
function confirmAcceptOrder() {
    if (!savedArrivalDate) {
        alert("Please set arrival date first");
        return;
    }

    fetch(`/admin/api/order/accept/${currentOrderId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            arrival_date: savedArrivalDate
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Accept failed");

        return fetch(`/admin/notification/delete/${currentNotificationId}`, {
            method: "POST"
        });
    })
    .then(() => {
        closeOrderDetails();
        loadNotifications();
    })
    .catch(err => alert(err.message));
}

/* CLOSE HELPERS */
function closeOrderDetails() {
    document.getElementById("orderDetailsModal")
        .classList.add("hidden");
}

function closeAcceptModal() {
    document.getElementById("acceptModal")
        .classList.add("hidden");
}

/* CLOSE NOTIFICATION ONLY */
function closeNotification(notificationId) {
    fetch(`/admin/notification/delete/${notificationId}`, {
        method: "POST"
    }).then(loadNotifications);
}

/* SEND INVOICE */
function sendInvoice(orderId, notificationId) {
    fetch(`/admin/api/invoice/send/${orderId}`, {
        method: "POST"
    })
    .then(res => {
        if (!res.ok) throw new Error("Invoice failed");

        return fetch(`/admin/notification/delete/${notificationId}`, {
            method: "POST"
        });
    })
    .then(() => loadNotifications())
    .catch(err => alert(err.message));
}

/* INIT */
loadNotifications();
</script>

</body>
</html>
